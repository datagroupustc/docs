## 功能模块说明

此部分是为了便于合作开发，将模块的相关说明写于此处，以方便对接。

- **功能概述**：说明模块的功能，和调用此模块的场景
- **时间安排**：2019.03.20---2019.03.25
- **开发状态**：已完成、测试中、正在进行、有待开发。
- **负责人**：负责此模块开发的负责人
- **运行环境**：正常运行此模块所需的环境，例如python程序，在服务器上运行时是使用哪个虚拟环境
- **部署位置**：服务器存放此程序的位置
- **输入参数及说明**：
   - 参数1名称，类型，含义
   - 参数2名称，类型，含义
   - .....
- **输出参数及说明**：输出的结果应为数据库中的位置信息，或可以直接返回的数值信息，如果是较为复杂的结果，例如程序产生的是json文件，在说明文件地址的同时要声明json文件格式。
   - 结果变量1名称，类型，含义
   - result.json例如
```javascript
{
	"dataType":"字符串类型,代表数据类型,和表中的content_type不同,是用户在上传数据集时设置的.下述所有string类型大小限制可为512字符",
	"dataFunction":"字符串类型,代表数据集的功能,和表中的application_field不同,是用户在上传数据集时设置的描述数据功能的自然语言.",
	"attributeSet":{//设置数据属性相关的信息
		"whetherReGenerate":false,//是否可再生？
		"whetherTimeSentivite":false,//时间敏感？
		"whetherExclusive":false//使用排他性？（允许多个买家同时使用？）
	},
	"collectionSet":{//针对于数据收集的配置描述
		"timeSpan":[1545133206808,1545133206808],//收集数据的时间区间,是两个Date类型数据构成的数组
		"locationSpan":"收集数据的地理位置,使用string类型",
		"otherInfo":"其他能够描述数据生成设置的语句,例如该数据是从嘈杂环境采集的人声数据.string类型",
		"sourceUrl":"只应用于平台采集数据使用,不开放给上传者填写,string类型"
	},
	"totalInfo":"用户或平台填写的,描述整体信息的语句,上述信息都可以以字符串格式存在此处,是至少应有的描述信息"
}
```
   - .....
- **调用示例与结果**：给出调用模块的命令，以及返回的示例结果
- **模块内部异常处理机制**：
   - 说明模块内部的异常处理机制与异常码定义，在例如“输入错误”等常见情况下能够检测出
   - 返回结果中应包含状态码和错误信息：例如flag=0为正常执行，flag=101为某种异常，errorMsg=xxxx为异常信息
   - 或者通过log文件记录异常，而非在结果中返回异常信息
- **其他说明与补充**

### API

#### app
- **功能概述**
   - 创建服务，监听3002端口
   - 解析收到的api调用请求
   - 验证参数
   - 调用api，并返回结果
   - 更新数据库，存储调用记录等
- **开发状态**
- **负责人**
   - lmj123@mail.ustc.edu.cn
- **运行环境**
- **部署位置**
   - [API/app.js](https://github.com/santaizi/API/blob/master/app.js)
- **输入参数及说明**

| 名称          | 类型 | 说明                                                         |
| ------------- | ---- | ------------------------------------------------------------ |
| system_params | JSON | 系统参数，包括api_id,dataset_id,api_key,timestamp,signature，详见[模型文档](https://222.195.92.29/owncloud/index.php/apps/files/?dir=/api%E7%BB%84%E6%96%87%E6%A1%A3%E5%85%B1%E4%BA%AB/%E6%A8%A1%E5%9E%8B%E6%96%87%E6%A1%A3&fileid=1493226) |
| model_params  | JSON | 模型参数，详见[模型文档](https://222.195.92.29/owncloud/index.php/apps/files/?dir=/api%E7%BB%84%E6%96%87%E6%A1%A3%E5%85%B1%E4%BA%AB/%E6%A8%A1%E5%9E%8B%E6%96%87%E6%A1%A3&fileid=1493226) |

- **输出参数及说明**

| 名称        | 类型       | 说明                                                        |
| ----------- | ---------- | ----------------------------------------------------------- |
| status_code | int        | 表示调用状态。400表示调用成功，其他值表示调用出现相应的错误 |
| accuracy    | dictionary | 表示交叉验证的模型精度                                      |

- **调用示例与结果**
   - 请求示例

    ~~~javascript
    var client = request.newClient('http://localhost:3002/');

    var request = {
           model_params : {
                       k: 5,
                       metric:"minkowski",
                       cv:5
                       },

           system_params:{
                       api_id : 2,
                       dataset_id : 2,
                       api_key:"xxx",
                       signature:"xxx",
                       timestamp:2018xxx,
                       }

           }

    client.post('/model', request, function(err, res, body) {
     //nothing
    });
    ~~~

   - 返回示例

   ~~~javascript
   //成功示例
   status_code = 400!
   accuracy = {"0":0.9206349206349206,"1":0.8492063492063492,"2":0.9285714285714286,"3":0.9596774193548387,"4":0.8780487804878049}

   //失败示例
   the api_key doesnt exist!

   ~~~


- **程序内部异常处理机制**
- **其他说明与补充**
   - 算法流程
      - app ![](figure/api-app.png)
      - rout ![](figure/api-rout.png)


#### real-time-process
- **功能概述**
   - 传输模型训练进度信息给前端，用于绘制模型训练过程中实时的精度、loss变化，以及进度条。
   - 需要前端创建tcp socket server，用于接收数据
- **开发状态**
- **负责人**
   - yang12@mail.ustc.edu.cn
- **运行环境**
- **部署位置**
   - /datapool/workspace/jiangshanyang/ml_model/arith
- **输入参数及说明**

| 名称 | 类型   | 来源     | 说明                                                         |
| ---- | ------ | -------- | ------------------------------------------------------------ |
| ip   | string | nodejs端 | tcp socket server的地址。<br>由前端转交nodejs端，再由nodejs端传给python代码 |

- **输出参数及说明**

| 名称           | 类型   | 目的地            | 说明                                         |
| -------------- | ------ | ----------------- | -------------------------------------------- |
| Train_test_tag | bool   | tcp socket server | 标记，区分当前状态。1为训练信息，0位验证信息 |
| Progress_epoch | float  | tcp socket server | 当前训练或者验证的epoch进度                  |
| Loss           | float  | tcp socket server | 当前训练或者验证的Loss值                     |
| Accuracy       | float  | tcp socket server | 当前训练或者验证的准确度accuracy             |
| result_url     | string | nodejs端          | 运行结果的存储路径                           |
| accuracy       | json   | nodejs端          | 模型精度                                     |

- **调用示例与结果**
- **程序内部异常处理机制**
- **其他说明与补充**
   - 算法流程
      - 接受nodejs端的调用请求及参数
      - 导入数据集
      - 训练神经网络
      - 与tcp socket server建立接连，并在每个训练batch结束时计算当前训练accuracy和loss，以tcp socket的方式传输给前端
      - 返回训练结果给nodejs端


### 数据理解与检索部分

#### video_detect_keyframe
- **功能概述**
   - 抽取视频关键帧
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 视频路径
- **输出参数及说明**
   - 关键帧存储路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### image_detect_object
- **功能概述**
   - 检测图片中的物体
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 图片文件夹路径
- **输出参数及说明**
   - 模型运行结果存储路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### image_classify_scene
- **功能概述**
   - 识别图片的场景类别
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 图片文件夹路径
- **输出参数及说明**
   - 模型运行结果存储路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### image_detect_face
- **功能概述**
   - 检测图片中的人脸
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 图片文件夹路径
- **输出参数及说明**
   - 模型运行结果存储路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### image_detect_skeleton
- **功能概述**
   - 检测图片中的人物骨架
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 图片文件夹路径
- **输出参数及说明**
   - 模型运行结果存储路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### audio_recognize_speech
- **功能概述**
   - 识别音频中的英语
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 音频文件夹路径
- **输出参数及说明**
   - 模型运行结果存储路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### utility_image_object-detection
- **功能概述**
   - 评估图片数据集的物体检测效用
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 模型运行结果路径
- **输出参数及说明**
   - 数据集效用评估分数
- **调用示例与结果**
- **程序内部异常处理机制**

#### utility_image_face-detection
- **功能概述**
   - 评估图片数据集的人脸检测效用
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 模型运行结果路径
- **输出参数及说明**
   - 数据集效用评估分数
- **调用示例与结果**
- **程序内部异常处理机制**

#### utility_image_scene-classification
- **功能概述**
   - 评估图片数据集的场景分类效用
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 模型运行结果路径
- **输出参数及说明**
   - 数据集效用评估分数
- **调用示例与结果**
- **程序内部异常处理机制**
utility_image_skeleton-detection	评估图片数据集的骨架检测效用	模型运行结果路径	数据集效用评估分数
#### utility_image_skeleton-detection
- **功能概述**
   - 评估图片数据集的骨架检测效用
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 模型运行结果路径
- **输出参数及说明**
   - 数据集效用评估分数
- **调用示例与结果**
- **程序内部异常处理机制**

#### utility_audio_speech-recognition
- **功能概述**
   - 评估音频数据集的语音识别效用
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 模型运行结果路径
- **输出参数及说明**
   - 数据集效用评估分数
- **调用示例与结果**
- **程序内部异常处理机制**

#### scheduler_video
- **功能概述**
   - 调度视频待运行程序
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 视频数据集表
- **输出参数及说明**
- **调用示例与结果**
- **程序内部异常处理机制**

#### scheduler_image
- **功能概述**
   - 调度图片待运行程序
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 图片数据集表
- **输出参数及说明**
- **调用示例与结果**
- **程序内部异常处理机制**

#### scheduler_audio
- **功能概述**
   - 调度音频待运行程序
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 音频数据集表
- **输出参数及说明**
- **调用示例与结果**
- **程序内部异常处理机制**

#### scheduler_text
- **功能概述**
   - 调度文本待运行程序
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 文本数据集表
- **输出参数及说明**
- **调用示例与结果**
- **程序内部异常处理机制**

#### index_dataunit
- **功能概述**
   - 构建/更新数据元的索引文件
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 模型运行结果路径   
   - 数据集元信息表
- **输出参数及说明**
   - 索引文件存储路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### index_dataset
- **功能概述**
   - 构建/更新数据集的索引文件
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 模型运行结果路径
   - 数据集元信息表
- **输出参数及说明**
   - 索引文件存储路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### search_dataunit
- **功能概述**
   - 检索数据元
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - query form （前端传入）
- **输出参数及说明**
   - 检索结果 （传回前端）
- **调用示例与结果**
- **程序内部异常处理机制**

#### search_dataset
- **功能概述**
   - 检索数据集
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - query form （前端传入）
- **输出参数及说明**
   - 检索结果 （传回前端）
- **调用示例与结果**
- **程序内部异常处理机制**

### 数据脱敏

#### text_privacy_protection
- **功能概述**
   - 文本数据脱敏
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 数据库读入数据，前端获取用户配置
- **输出参数及说明**
   - 脱敏后数据集，配置参数存储到数据库，返回给前端数据集路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### table_privacy_protection
- **功能概述**
   - 表格数据脱敏
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 数据库读入数据，前端获取用户配置
- **输出参数及说明**
   - 脱敏后数据集，配置参数存储到数据库，返回给前端数据集路径
- **调用示例与结果**
- **程序内部异常处理机制**

#### image_privacy_protection
- **功能概述**
   - 图片数据脱敏
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 数据库读入数据，前端获取用户配置（需依赖数据理解组对图片多种模型的理解结果）
- **输出参数及说明**
   - 脱敏后数据集，配置参数存储到数据库，返回给前端数据集路径
- **调用示例与结果**
- **程序内部异常处理机制**

### 数据溯源与追踪

![ ](figure/track1.png  "数据追溯说明1")

#### querySimiliar
- **功能概述**
   - 对于新数据，查询相似的数据结果，并返回相似度值和报告
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 数据集element id
- **输出参数及说明**
   - 相似数据结果和相似度报告
- **调用示例与结果**
- **程序内部异常处理机制**

#### updateDatabase
- **功能概述**
   - 对于新数据，确认和现有数据不相似后，将其指纹写入数据库
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 数据集element id
- **输出参数及说明**
   - 将哈希值写入数据库
- **调用示例与结果**
- **程序内部异常处理机制**

#### forest
- **功能概述**
   - 获取不同数据类型各自哈希值组成的哈希森林
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 数据类型
- **输出参数及说明**
   - 哈希森林
- **调用示例与结果**
- **程序内部异常处理机制**

#### updateForest
- **功能概述**
   - 查询是否有新的数据未被纳入森林索引，如果没有，纳入后重建森林
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 数据类型
- **输出参数及说明**
   - 哈希森林
- **调用示例与结果**
- **程序内部异常处理机制**

### 数据质量评估

![ ](figure/quality1.png  "数据质量评估1")

#### image_quality_assessment
- **功能概述**
   - 图片质量评估
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 图片集
- **输出参数及说明**
   - 图片各个维度质量评估结果
- **调用示例与结果**
- **程序内部异常处理机制**

#### text_quality_assessment
- **功能概述**
   - 文本质量评估
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 文本集
- **输出参数及说明**
   - 文本各个维度质量评估结果
- **调用示例与结果**
- **程序内部异常处理机制**

#### video_quality_assessment
- **功能概述**
   - 视频质量评估
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 视频集
- **输出参数及说明**
   - 视频质量评估结果
- **调用示例与结果**
- **程序内部异常处理机制**

#### audio_quality_assessment
- **功能概述**
   - 音频质量评估
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 音频集
- **输出参数及说明**
   - 音频质量评估结果
- **调用示例与结果**
- **程序内部异常处理机制**

#### table_quality_assessment
- **功能概述**
   - 表格质量评估
- **开发状态**
- **负责人**
- **运行环境**
- **部署位置**
- **输入参数及说明**
   - 表格集
- **输出参数及说明**
   - 表格各个维度质量评估结果
- **调用示例与结果**
- **程序内部异常处理机制**

### 数据库与存储组
